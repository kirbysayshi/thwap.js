<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>Thwap Test</title>
		
		<style type="text/css">
		#soldat-stage { border: 1px solid #CCCCCC; }
		</style>
	</head>
	<body id="index" onload="">
		<canvas id="soldat-stage" height="800px" width="400px"></canvas>
		<div id="fpsMeter"></div>
		<script type="text/javascript" charset="utf-8" src='../FPSMonitor.js'></script>
		<script type="text/javascript" charset="utf-8" src='TVector.js'></script>
		<script type="text/javascript" charset="utf-8" src='TCell.js'></script>
		<script type="text/javascript" charset="utf-8" src='TGrid.js'></script>
		<script type="text/javascript" charset="utf-8" src='TObject.js'></script>
		<script type="text/javascript" charset="utf-8" src='TUtil.js'></script>
		<script type="text/javascript" charset="utf-8" src='Thwap.js'></script>
		
		<script type="text/javascript">
		window.onload = function(){
			var canvas = document.getElementById("soldat-stage");
			var ctx = canvas.getContext('2d');
			
			var FPSM = new FPSMonitor(30);
			var fps = document.getElementById('fpsMeter');
			THWAP = new Thwap(new TVector(400, 800, 0), new TVector(400, 800, 0), 50);
			THWAP.addWorldForce('earth-like gravity', new TVector(0, 0.1, 0));
			
			var circle = new TObject(TObject.CIRCLE, 10, new TVector(245,400,0));
			var rect = new TObject(TObject.RECTANGLE, new TVector(30, 10, 0), new TVector(205, 420, 0));
			var floor = new TObject(TObject.RECTANGLE, new TVector(250, 5, 0), new TVector(200, 630, 0));
			floor.behavior = TObject.FIXED;
			THWAP.add(circle);
			THWAP.add(rect);
			THWAP.add(floor);
			
			var intVal = setInterval(function(){
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				THWAP.grid.drawGrid(ctx);
				
				THWAP.step();
				var l = THWAP.objects.length;
				for(var o = 0; o < l; o++){
					var obj = THWAP.objects[o];
					switch(obj.type){
						case TObject.CIRCLE:
							ctx.beginPath();
							ctx.arc( obj.position.x, obj.position.y, obj.radius, 0, Math.PI*2, false );
							ctx.stroke();
							// draw center
							ctx.beginPath();
							ctx.arc( obj.position.x, obj.position.y, 0.5, 0, Math.PI*2, false );
							ctx.stroke();
							break;
						case TObject.RECTANGLE:
							ctx.strokeRect(obj.position.x - (obj.dimensions.x/2), obj.position.y - (obj.dimensions.y/2), obj.dimensions.x, obj.dimensions.y);
							// draw center
							ctx.beginPath();
							ctx.arc( obj.position.x, obj.position.y, 0.5, 0, Math.PI*2, false );
							ctx.stroke();
							break;
					}
					
					// draw containing cell
					ctx.lineWidth = 3.0;
					ctx.strokeStyle = 'green';
					ctx.strokeRect((obj.gridPosition.col*THWAP.grid.tilesize)+2, (obj.gridPosition.row*THWAP.grid.tilesize)+2, THWAP.grid.tilesize-4, THWAP.grid.tilesize-4);
					ctx.strokeStyle = 'black';
					ctx.lineWidth = 1.0;
					
				}
				
				//ctx.clearRect(0, 0, canvas.width, canvas.height);
				//ctx.fillStyle = "#000000";
				//ctx.fillRect( x, y, 10, 10);
				//ctx.fillStyle = "#CCCCCC";
				//ctx.fillRect(floor.position().x(), floor.position().y(),
				//	20, 20)
				fps.innerHTML = FPSM.check();
			}, 33);
			
			window.addEventListener('keydown', function(e){
				if(e.keyCode == 17) {
					clearInterval(intVal);
					console.log("execution stopped");
				}
				
				if(e.keyCode == 68) { // D
					circle.applyImpulseForce(new TVector(0.2, 0, 0));
				}
				
				if(e.keyCode == 65) { // A
					circle.applyImpulseForce(new TVector(-0.2, 0, 0));
				}
				
			}, false);
			
		};
		</script>
	</body>
</html>
